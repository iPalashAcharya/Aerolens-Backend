name: CI/CD â€” Dev

on:
  push:
    branches: ["development"]

permissions:
  contents: read
  id-token: write
  packages: write
  actions: read

concurrency:
  group: aerolens-dev-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::${{vars.AWS_ACCOUNT_ID}}:role/GitHubActions-Dev-Role
          aws-region: ${{vars.AWS_REGION}}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build Docker image
        run: |
          IMAGE="${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com/aerolens-portal-backend-dev:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
        env:
          DOCKER_BUILDKIT: 1

      - name: Send SSM command to deploy (dev instance)
        run: |
          INSTANCE_ID="${{vars.INSTANCE_ID}}"
          COMPOSE_FILE="${{vars.DEV_COMPOSE_FILE}}"
          SERVICE="backend-dev"
          IMAGE_TAG="${{ github.sha }}"
          ECR_REG="${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com"

          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy dev ${IMAGE_TAG}" \
            --parameters commands="[ 'cd ${{vars.DEV_FOLDER_LOCATION}} && \
              aws ecr get-login-password --region ${{vars.AWS_REGION}} | docker login --username AWS --password-stdin ${ECR_REG} && \
              docker pull ${ECR_REG}/aerolens-portal-backend-dev:${IMAGE_TAG} && \
              docker tag ${ECR_REG}/aerolens-portal-backend-dev:${IMAGE_TAG} aerolens-portal-backend-dev:latest && \
              docker-compose -f ${COMPOSE_FILE} up -d --remove-orphans ${SERVICE}' ]" \
            --region ${{vars.AWS_REGION}}
